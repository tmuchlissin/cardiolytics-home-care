{% extends "base.html" %} {% block content %}
<style>
  /* Transition for main content container on initial load */
  .main-content.initial-load {
    opacity: 0;
    animation: fadeIn 0.5s ease-in forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<!-- Flash Messages Container -->
<div class="w-full max-w-3xl mx-auto px-4">
  {% with messages = get_flashed_messages(with_categories=true,
  category_filter=['success', 'warning', 'error', 'attention']) %} {% if
  messages %}
  <div class="mb-4">
    {% for category, message in messages %}
    <div
      class="flash-message p-3 rounded-lg text-center font-semibold {% if category == 'success' %} bg-green-100 border border-green-400 text-green-700 {% elif category == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700 {% elif category == 'error' %} bg-red-100 border border-red-400 text-red-700 {% elif category == 'attention' %} bg-gray-100 border border-gray-400 text-gray-700 {% endif %}"
      role="alert"
    >
      <span class="block sm:inline">{{ message }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %} {% endwith %}
</div>

<!-- Main Content Container -->
<div class="px-5 py-1 main-content initial-load">
  <h1 class="text-xl sm:text-2xl font-bold mb-4">Dashboard Monitor</h1>

  <!-- Connect to Device Button -->
  <div class="mb-4">
    <button
      id="connectBtn"
      class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1.5 px-3 sm:py-2 sm:px-5 rounded-full shadow-md hover:from-sky-600 hover:to-cyan-600 focus:outline-none transition-all duration-300"
    >
      <i class="fas fa-plug animate-pulse text-sm sm:text-base"></i>
      Connect to Device
    </button>
  </div>

  <!-- Start Measurement Button -->
  <button
    id="startMeasurementBtn"
    class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-lime-500 to-green-500 text-white font-semibold py-1.5 px-3 sm:py-2 sm:px-5 rounded-full shadow-md hover:from-lime-600 hover:to-green-600 focus:outline-none transition-all duration-300 mb-4 hidden"
  >
    <i class="fas fa-heartbeat animate-bounce text-sm sm:text-base"></i>
    Start Measurement
  </button>

  <h2 class="text-lg sm:text-lg font-semibold mt-7">
    Latest Measurement Results
  </h2>

  <!-- Main Layout -->
  <div class="mt-3 space-y-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div
        class="bg-blue-400 hover:bg-blue-500 transition-colors duration-300 rounded-xl shadow-md p-4 text-white flex flex-col items-center"
      >
        <i class="fas fa-clock text-xl sm:text-2xl opacity-90"></i>
        <h3 class="text-xs sm:text-sm font-semibold mt-2">Timestamp</h3>
        <p class="text-base sm:text-lg font-bold" id="currentDatetime">
          {{ data.timestamp.strftime('%d-%m-%Y, %H:%M:%S WIB') if data else
          'N/A' }}
        </p>
      </div>
      <div
        class="bg-pink-200 hover:bg-pink-300 transition-colors duration-300 rounded-xl shadow-md p-4 text-pink-800 flex flex-col items-center"
      >
        <i class="fas fa-heart text-xl sm:text-2xl opacity-90"></i>
        <h3 class="text-xs sm:text-sm font-semibold mt-2">Pulse Pressure</h3>
        <p class="text-base sm:text-lg font-bold" id="pulsePressure">
          {{ (data.systolic - data.diastolic) if data else 'N/A' }} mmHg
        </p>
      </div>
      <div
        class="bg-purple-200 hover:bg-purple-300 transition-colors duration-300 rounded-xl shadow-md p-4 text-purple-800 flex flex-col items-center"
      >
        <i class="fas fa-tachometer-alt text-xl sm:text-2xl opacity-90"></i>
        <h3 class="text-xs sm:text-sm font-semibold mt-2">
          Mean Arterial Pressure
        </h3>
        <p class="text-base sm:text-lg font-bold" id="map">
          {{ ((data.systolic + 2 * data.diastolic) / 3) | int if data else 'N/A'
          }} mmHg
        </p>
      </div>
      <div
        class="bg-teal-200 hover:bg-teal-300 transition-colors duration-300 rounded-xl shadow-md p-4 text-teal-800 flex flex-col items-center"
      >
        <i class="fas fa-balance-scale text-xl sm:text-2xl opacity-90"></i>
        <h3 class="text-xs sm:text-sm font-semibold mt-2">Sys/Dia Ratio</h3>
        <p class="text-base sm:text-lg font-bold" id="ratio">
          {{ (data.systolic / data.diastolic) | round(1) if data else 'N/A' }}
        </p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 flex">
        <div
          class="bg-white border border-gray-100 rounded-xl shadow-sm lg:p-6 p-4 flex flex-col items-center justify-end w-full h-full"
        >
          <div class="text-center mb-2">
            <p class="text-sm sm:text-base font-semibold text-gray-800">
              AVG. BLOOD PRESSURE =
              <span
                class="text-sm sm:text-base font-semibold text-gray-800"
                id="avgBloodPressure"
              >
                {{ data.systolic if data else 'N/A' }}/{{ data.diastolic if data
                else 'N/A' }} mmHg
              </span>
            </p>
            <p
              id="bpStatus"
              class="text-sm sm:text-base font-semibold mb-4"
              style="{% if status == 'Hypotension' %}color: #3B82F6;{% elif status == 'Normal' %}color: #10B981;{% elif status == 'Prehypertension' %}color: #FBBF24;{% elif status == 'Stage 1 Hypertension' %}color: #F97316;{% elif status == 'Stage 2 Hypertension' %}color: #DC2626;{% else %}color: #6B7280;{% endif %}"
            >
              {{ status }}
            </p>
          </div>
          <div class="grid grid-cols-2 gap-4 w-full">
            <div class="flex flex-col items-center">
              <h3 class="text-sm font-bold text-gray-800 mb-0">Systolic</h3>
              <div
                id="systolicChart"
                class="w-full sm:max-w-[360px] h-[200px] sm:h-[220px]"
              ></div>
            </div>
            <div class="flex flex-col items-center">
              <h3 class="text-sm font-bold text-gray-800 mb-0">Diastolic</h3>
              <div
                id="diastolicChart"
                class="w-full sm:max-w-[360px] h-[200px] sm:h-[220px]"
              ></div>
            </div>
          </div>
        </div>
        <div
          id="combinedLegend"
          class="mt-4 flex flex-wrap justify-center gap-6"
        ></div>
      </div>

      <div class="lg:col-span-1 flex">
        <div
          class="bg-white border border-gray-100 rounded-xl shadow-sm lg:p-6 p-4 flex flex-col items-center justify-end w-full h-full"
        >
          <div class="text-center mb-2">
            <p class="text-sm sm:text-base font-semibold text-gray-800">
              PULSE
            </p>
            <p
              id="hrStatus"
              class="text-sm sm:text-base font-semibold mb-4"
              style="{% if hrStatus == 'Bradycardia' %}color: #3B82F6;{% elif hrStatus == 'Normal' %}color: #10B981;{% elif hrStatus == 'Tachycardia' %}color: #EF4444;{% else %}color: #6B7280;{% endif %}"
            >
              {{ hrStatus }}
            </p>
          </div>
          <h3 class="text-sm font-bold text-gray-800 mb-0">Heart Rate</h3>
          <div
            id="heartRateChart"
            class="w-full sm:max-w-[360px] h-[200px] sm:h-[220px]"
          ></div>
        </div>
      </div>

      <div class="lg:col-span-3">
        <div
          class="bg-white border border-gray-100 rounded-xl shadow-sm p-4 lg:p-6 h-[250px] sm:h-[300px] lg:h-[350px]"
        >
          <h3
            class="text-base sm:text-lg font-semibold text-center text-gray-800 mb-3"
          >
            Blood Pressure & Heart Rate Trend
          </h3>
          <canvas id="trendChart" class="w-full h-full mb-5"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Uploading Overlay -->
<div
  id="predictOverlay"
  class="fixed inset-0 hidden z-[999] bg-black bg-opacity-60 flex items-center justify-center"
>
  <div class="flex flex-col items-center space-y-4 text-white">
    <svg
      class="animate-spin h-10 w-10"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle
        class="opacity-25"
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        stroke-width="4"
      ></circle>
      <path
        class="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
      ></path>
    </svg>
    <p class="text-lg font-semibold">Processingâ€¦ Please wait</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.6.1/justgage.min.js"></script>
<script>
  // Add transition handling
  document.addEventListener("DOMContentLoaded", function () {
    const mainContent = document.querySelector(".main-content");
    if (mainContent) {
      mainContent.addEventListener("animationend", () => {
        mainContent.classList.remove("initial-load");
      });
    }
  });

  const state = {
    isConnected: false,
    isMeasuring: false,
    latestData: null,
    trendData: {
      labels: [],
      systolic: [],
      diastolic: [],
      pulse_rate: [],
    },
  };

  const utils = {
    showOverlay(message) {
      const overlay = document.getElementById("predictOverlay");
      const overlayMessage = overlay.querySelector("p");
      overlayMessage.textContent = message;
      overlay.classList.remove("hidden");
    },

    hideOverlay() {
      document.getElementById("predictOverlay").classList.add("hidden");
    },

    validateData(data) {
      return (
        data &&
        typeof data.systolic === "number" &&
        data.systolic >= 70 &&
        data.systolic <= 181 &&
        typeof data.diastolic === "number" &&
        data.diastolic >= 40 &&
        data.diastolic <= 111 &&
        typeof data.pulse_rate === "number" &&
        data.pulse_rate >= 40 &&
        data.pulse_rate <= 140 &&
        data.timestamp
      );
    },

    getBPStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "Hypotension";
      if (systolic >= 160 || diastolic >= 100) return "Stage 2 Hypertension";
      if (systolic >= 140 || diastolic >= 90) return "Stage 1 Hypertension";
      if (systolic >= 120 || diastolic >= 80) return "Prehypertension";
      return "Normal";
    },

    getHRStatus(pulseRate) {
      if (!pulseRate) return "N/A";
      return pulseRate < 60
        ? "Bradycardia"
        : pulseRate > 100
        ? "Tachycardia"
        : "Normal";
    },

    formatTimestamp(timestamp) {
      const parts = timestamp.split(", ");
      const date = parts[0];
      const timeParts = parts[1].split(":");
      const time = `${timeParts[0]}:${timeParts[1]} ${
        timeParts[2].split(" ")[1]
      }`;
      return `${date}\n${time}`;
    },

    getGaugeColor(value, ranges) {
      for (const range of ranges) {
        if (value >= range.from && value <= range.to) {
          console.log(
            `Value ${value} falls in range ${range.from}-${range.to}, color: ${range.color}`
          );
          return range.color;
        }
      }
      console.log(
        `Value ${value} out of range, defaulting to ${ranges[0].color}`
      );
      return ranges[0].color; // Default to first range color if out of bounds
    },
  };

  const initializeGaugeChart = (chartId, type) => {
    const ranges =
      type === "Heart Rate"
        ? [
            { lo: 40, hi: 59, color: "#3B82F6" }, // Bradycardia: Vibrant Blue
            { lo: 60, hi: 99, color: "#10B981" }, // Normal: Bright Green
            { lo: 100, hi: 140, color: "#EF4444" }, // Tachycardia: Vivid Red
          ]
        : type === "Systolic"
        ? [
            { lo: 70, hi: 89, color: "#3B82F6" }, // Hypotension - Soft blue
            { lo: 90, hi: 119, color: "#10B981" }, // Normal - Emerald green
            { lo: 120, hi: 139, color: "#FBBF24" }, // Prehypertension - Amber
            { lo: 140, hi: 159, color: "#F97316" }, // Stage 1 Hypertension - Orange
            { lo: 160, hi: 181, color: "#DC2626" }, // Stage 2 Hypertension - Red
          ]
        : [
            { lo: 40, hi: 59, color: "#3B82F6" }, // Hypotension
            { lo: 60, hi: 79, color: "#10B981" }, // Normal
            { lo: 80, hi: 89, color: "#FBBF24" }, // Prehypertension
            { lo: 90, hi: 99, color: "#F97316" }, // Stage 1 Hypertension
            { lo: 100, hi: 111, color: "#DC2626" }, // Stage 2 Hypertension
          ];

    const minValue = type === "Heart Rate" ? 40 : type === "Systolic" ? 70 : 40;
    const maxValue =
      type === "Heart Rate" ? 140 : type === "Systolic" ? 181 : 111;
    const unit = type === "Heart Rate" ? "BPM" : "mmHg";

    const updateGaugeValue = (value) => {
      console.log(`Updating ${type} gauge with value: ${value}`);
      if (value >= minValue && value <= maxValue) {
        return value;
      } else {
        console.warn(
          `Value ${value} out of range [${minValue}, ${maxValue}] for ${type}`
        );
        return minValue; // Default to minimum value if out of range
      }
    };

    return new JustGage({
      id: chartId,
      value: updateGaugeValue(0), // Initialize with default value
      min: minValue,
      max: maxValue,
      title: type,
      label: unit,
      decimals: 0,
      gaugeWidthScale: 0.6,
      customSectors: {
        percents: false, // Use absolute values
        ranges: ranges,
      },
      levelColors: ranges.map((range) => range.color), // Explicitly set levelColors for gauge coloring
      counter: true,
      relativeGaugeSize: true,
      titleFontFamily: "Poppins, sans-serif",
      titleFontWeight: "bold",
      valueFontFamily: "Poppins, sans-serif",
      labelFontFamily: "Poppins, sans-serif",
      valueFontSize: 24,
      titleOffsetY: 20,
      pointer: true,
      pointerOptions: {
        toplength: -10,
        bottomlength: 10,
        bottomwidth: 5,
        color: "#7b7b7b",
        stroke: "#ffffff",
        stroke_width: 2,
      },
      shadowOpacity: 0.2,
      shadowSize: 5,
      shadowVerticalOffset: 3,
      valueMinFontSize: 16,
      onAnimationEnd: function () {
        console.log(`${type} gauge animation ended with value: ${this.value}`);
      },
    });
  };

  const initializeTrendChart = () => {
    const ctx = document.getElementById("trendChart").getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: state.trendData.labels,
        datasets: [
          {
            label: "Systolic (mmHg)",
            data: state.trendData.systolic,
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.1)",
            pointBackgroundColor: "rgba(255, 99, 132, 1)",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 4,
            tension: 0.4,
            fill: false,
          },
          {
            label: "Diastolic (mmHg)",
            data: state.trendData.diastolic,
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.1)",
            pointBackgroundColor: "rgba(54, 162, 235, 1)",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 4,
            tension: 0.4,
            fill: false,
          },
          {
            label: "Heart Rate (BPM)",
            data: state.trendData.pulse_rate,
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.1)",
            pointBackgroundColor: "rgba(75, 192, 192, 1)",
            pointBorderColor: "#ffffff",
            pointBorderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 4,
            tension: 0.4,
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
            labels: {
              font: {
                size: 14,
                family: "Poppins, sans-serif",
                weight: "bold",
              },
              padding: 15,
              usePointStyle: true,
              boxWidth: 10,
              boxHeight: 10,
            },
          },
          tooltip: {
            mode: "index",
            intersect: false,
            backgroundColor: "rgba(0, 0, 0, 0.8)",
            titleFont: {
              size: 14,
              weight: "bold",
              family: "Poppins, sans-serif",
            },
            bodyFont: { size: 12, family: "Poppins, sans-serif" },
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: function (context) {
                return `${context.dataset.label}: ${context.parsed.y}`;
              },
            },
          },
        },
        scales: {
          x: {
            title: {
              display: false,
              text: "Date and Time",
              font: { size: 14, weight: "bold", family: "Poppins, sans-serif" },
              color: "#333",
            },
            grid: {
              display: false,
            },
            ticks: {
              display: false,
              font: { size: 12, family: "Poppins, sans-serif" },
              color: "#333",
              maxRotation: 45,
              minRotation: 45,
              maxTicksLimit: 8,
              callback: function (value, index, values) {
                return this.getLabelForValue(value).split("\n");
              },
            },
          },
          y: {
            title: {
              display: false,
              text: "Value",
              font: { size: 14, weight: "bold", family: "Poppins, sans-serif" },
              color: "#333",
            },
            grid: {
              color: "rgba(0, 0, 0, 0.2)",
              borderDash: [5, 5],
              tickBorderDash: [5, 5],
              drawTicks: true,
            },
            ticks: {
              font: { size: 10, family: "Poppins, sans-serif" },
              color: "#333",
              stepSize: 40,
              padding: 15,
            },
            suggestedMin: 0,
            suggestedMax: 200,
          },
        },
        elements: {
          line: {
            borderCapStyle: "round",
            borderJoinStyle: "round",
          },
        },
        layout: {
          padding: {
            bottom: 30,
          },
        },
      },
    });
  };

  const updateChart = (chart, needleValue, ranges) => {
    if (!chart || !needleValue || isNaN(needleValue)) return;
    chart.config.levelColors = ranges.map((range) => range.color); // Update levelColors based on ranges
    chart.refresh(needleValue);
  };

  const updateTrendChart = (data) => {
    if (!utils.validateData(data)) return;

    state.trendData.labels.push(utils.formatTimestamp(data.timestamp));
    state.trendData.systolic.push(data.systolic);
    state.trendData.diastolic.push(data.diastolic);
    state.trendData.pulse_rate.push(data.pulse_rate);

    if (state.trendData.labels.length > 30) {
      state.trendData.labels.shift();
      state.trendData.systolic.shift();
      state.trendData.diastolic.shift();
      state.trendData.pulse_rate.shift();
    }

    charts.trend.data.labels = [...state.trendData.labels];
    charts.trend.data.datasets[0].data = [...state.trendData.systolic];
    charts.trend.data.datasets[1].data = [...state.trendData.diastolic];
    charts.trend.data.datasets[2].data = [...state.trendData.pulse_rate];
    charts.trend.update();
  };

  const updateDashboard = (records) => {
    console.log("Records received:", records);
    if (!records || records.length === 0 || !utils.validateData(records[0])) {
      console.warn("Invalid or missing data");
      return;
    }

    const latestData = records[0];
    state.latestData = latestData;

    document.getElementById("currentDatetime").textContent =
      latestData.timestamp;
    document.getElementById("pulsePressure").textContent = `${
      latestData.systolic - latestData.diastolic
    } mmHg`;
    document.getElementById("map").textContent = `${Math.round(
      (latestData.systolic + 2 * latestData.diastolic) / 3
    )} mmHg`;
    document.getElementById("ratio").textContent = (
      latestData.systolic / latestData.diastolic
    ).toFixed(1);
    document.getElementById(
      "avgBloodPressure"
    ).textContent = `${latestData.systolic}/${latestData.diastolic} mmHg`;

    const bpStatus = utils.getBPStatus(
      latestData.systolic,
      latestData.diastolic
    );
    const bpStatusElement = document.getElementById("bpStatus");
    bpStatusElement.textContent = bpStatus;
    bpStatusElement.style.color =
      bpStatus === "Hypotension"
        ? "#3B82F6"
        : bpStatus === "Normal"
        ? "#10B981"
        : bpStatus === "Prehypertension"
        ? "#FBBF24"
        : bpStatus === "Stage 1 Hypertension"
        ? "#F97316"
        : bpStatus === "Stage 2 Hypertension"
        ? "#DC2626"
        : "#6B7280";

    document.getElementById("hrStatus").textContent = utils.getHRStatus(
      latestData.pulse_rate
    );
    document.getElementById("hrStatus").style.color =
      utils.getHRStatus(latestData.pulse_rate) === "Bradycardia"
        ? "#3B82F6"
        : utils.getHRStatus(latestData.pulse_rate) === "Normal"
        ? "#10B981"
        : utils.getHRStatus(latestData.pulse_rate) === "Tachycardia"
        ? "#EF4444"
        : "#6B7280";

    const systolicRanges = [
      { from: 70, to: 89, color: "#3B82F6" },
      { from: 90, to: 119, color: "#10B981" },
      { from: 120, to: 139, color: "#FBBF24" },
      { from: 140, to: 159, color: "#F97316" },
      { from: 160, to: 181, color: "#DC2626" },
    ];
    const diastolicRanges = [
      { from: 40, to: 59, color: "#3B82F6" },
      { from: 60, to: 79, color: "#10B981" },
      { from: 80, to: 89, color: "#FBBF24" },
      { from: 90, to: 99, color: "#F97316" },
      { from: 100, to: 111, color: "#DC2626" },
    ];
    const heartRateRanges = [
      { from: 40, to: 59, color: "#3B82F6" },
      { from: 60, to: 99, color: "#10B981" },
      { from: 100, to: 140, color: "#EF4444" },
    ];

    updateChart(charts.systolic, latestData.systolic, systolicRanges);
    updateChart(charts.diastolic, latestData.diastolic, diastolicRanges);
    updateChart(charts.heartRate, latestData.pulse_rate, heartRateRanges);

    state.trendData.labels = [];
    state.trendData.systolic = [];
    state.trendData.diastolic = [];
    state.trendData.pulse_rate = [];

    records.reverse().forEach((data) => {
      if (utils.validateData(data)) {
        state.trendData.labels.push(utils.formatTimestamp(data.timestamp));
        state.trendData.systolic.push(data.systolic);
        state.trendData.diastolic.push(data.diastolic);
        state.trendData.pulse_rate.push(data.pulse_rate);
      }
    });

    charts.trend.data.labels = [...state.trendData.labels];
    charts.trend.data.datasets[0].data = [...state.trendData.systolic];
    charts.trend.data.datasets[1].data = [...state.trendData.diastolic];
    charts.trend.data.datasets[2].data = [...state.trendData.pulse_rate];
    charts.trend.update();
  };

  const fetchData = async () => {
    try {
      const response = await fetch("/bp-monitor/api/get_blood_pressure");
      const records = await response.json();
      console.log("Fetched records:", records);
      if (Array.isArray(records) && records.length > 0) {
        updateDashboard(records);
      } else {
        console.warn("No valid data received");
      }
    } catch (error) {
      console.error("Error fetching data:", error);
      utils.showOverlay("Error retrieving data");
      setTimeout(utils.hideOverlay, 2000);
    }
  };

  const handleConnect = async () => {
    if (state.isConnected) return;

    utils.showOverlay("Checking Device Connection...");
    try {
      const response = await fetch("/bp-monitor/check_connection", {
        method: "POST",
      });
      const data = await response.json();

      setTimeout(() => {
        utils.showOverlay(data.message || `Connection: ${data.connection}`);
        setTimeout(() => {
          utils.hideOverlay();
          if (data.status === "success" && data.connection === "connected") {
            state.isConnected = true;
            document.getElementById("connectBtn").classList.add("hidden");
            document
              .getElementById("startMeasurementBtn")
              .classList.remove("hidden");
          }
        }, 2000);
      }, 2000);
    } catch (error) {
      console.error("Error checking connection:", error);
      utils.showOverlay("Failed to Connect");
      setTimeout(utils.hideOverlay, 2000);
    }
  };

  const handleStartMeasurement = async () => {
    if (state.isMeasuring || !state.isConnected) return;

    state.isMeasuring = true;
    utils.showOverlay("Measuring Blood Pressure... Please Wait");

    try {
      await new Promise((resolve) => setTimeout(resolve, 10000)); // Simulate 10-second measurement
      const response = await fetch("/bp-monitor/start_measurement", {
        method: "POST",
      });
      const data = await response.json();
      console.log("Flask response:", data);

      if (data.status === "success") {
        utils.showOverlay("Waiting for data...");
        // Poll for new data
        const maxPollAttempts = 10;
        let pollCount = 0;
        const pollInterval = setInterval(async () => {
          try {
            const response = await fetch("/bp-monitor/api/get_blood_pressure");
            const records = await response.json();
            if (
              Array.isArray(records) &&
              records.length > 0 &&
              utils.validateData(records[0])
            ) {
              clearInterval(pollInterval);
              utils.showOverlay("Measurement successful!");
              setTimeout(() => {
                updateDashboard(records);
                utils.hideOverlay();
                state.isMeasuring = false;
              }, 2000);
            } else if (pollCount >= maxPollAttempts) {
              clearInterval(pollInterval);
              utils.showOverlay("No new data received");
              setTimeout(() => {
                utils.hideOverlay();
                state.isMeasuring = false;
              }, 2000);
            }
            pollCount++;
          } catch (error) {
            console.error("Error polling data:", error);
            clearInterval(pollInterval);
            utils.showOverlay("Error retrieving data");
            setTimeout(() => {
              utils.hideOverlay();
              state.isMeasuring = false;
            }, 2000);
          }
        }, 2000);
      } else {
        throw new Error(data.message || "Failed to start measurement");
      }
    } catch (error) {
      console.error("Measurement Error:", error);
      utils.showOverlay(error.message || "Error During Measurement");
      setTimeout(() => {
        utils.hideOverlay();
        state.isMeasuring = false;
      }, 2000);
    }
  };

  const init = () => {
    const initialData = {
      systolic: "{{ data.systolic if data else 'N/A' }}",
      diastolic: "{{ data.diastolic if data else 'N/A' }}",
      pulse_rate: "{{ data.pulse_rate if data else 'N/A' }}",
      timestamp:
        "{{ data.timestamp.strftime('%d-%m-%Y, %H:%M:%S WIB') if data else 'N/A' }}",
    };

    if (utils.validateData(initialData)) {
      updateDashboard([initialData]);
    }

    fetchData();

    document
      .getElementById("connectBtn")
      .addEventListener("click", handleConnect);
    document
      .getElementById("startMeasurementBtn")
      .addEventListener("click", handleStartMeasurement);

    state.isConnected = false;
    document.getElementById("connectBtn").classList.remove("hidden");
    document.getElementById("startMeasurementBtn").classList.add("hidden");
  };

  window.addEventListener("resize", () => {
    charts.systolic.destroy();
    charts.diastolic.destroy();
    charts.heartRate.destroy();
    charts.systolic = initializeGaugeChart("systolicChart", "Systolic");
    charts.diastolic = initializeGaugeChart("diastolicChart", "Diastolic");
    charts.heartRate = initializeGaugeChart("heartRateChart", "Heart Rate");
    if (state.latestData) {
      const systolicRanges = [
        { from: 70, to: 89, color: "#3B82F6" },
        { from: 90, to: 119, color: "#10B981" },
        { from: 120, to: 139, color: "#FBBF24" },
        { from: 140, to: 159, color: "#F97316" },
        { from: 160, to: 181, color: "#DC2626" },
      ];
      const diastolicRanges = [
        { from: 40, to: 59, color: "#3B82F6" },
        { from: 60, to: 79, color: "#10B981" },
        { from: 80, to: 89, color: "#FBBF24" },
        { from: 90, to: 99, color: "#F97316" },
        { from: 100, to: 111, color: "#DC2626" },
      ];
      const heartRateRanges = [
        { from: 40, to: 59, color: "#3B82F6" },
        { from: 60, to: 99, color: "#10B981" },
        { from: 100, to: 140, color: "#EF4444" },
      ];
      updateChart(charts.systolic, state.latestData.systolic, systolicRanges);
      updateChart(
        charts.diastolic,
        state.latestData.diastolic,
        diastolicRanges
      );
      updateChart(
        charts.heartRate,
        state.latestData.pulse_rate,
        heartRateRanges
      );
    }
  });

  const charts = {
    systolic: initializeGaugeChart("systolicChart", "Systolic"),
    diastolic: initializeGaugeChart("diastolicChart", "Diastolic"),
    heartRate: initializeGaugeChart("heartRateChart", "Heart Rate"),
    trend: initializeTrendChart(),
  };

  setTimeout(function () {
    let flashMessages = document.querySelectorAll(".flash-message");
    flashMessages.forEach(function (msg) {
      msg.style.transition = "opacity 0.5s";
      msg.style.opacity = "0";
      setTimeout(() => msg.remove(), 500);
    });
  }, 3000);

  init();
</script>
{% endblock %}
